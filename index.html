<!DOCTYPE html>
<html lang="gu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Full Screen Scanner</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link  href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

    <style>
        /* рлз. ркмрлЛркбрлА ркорк╛рк░рлНркЬрк┐рки ркХрк╛ркврлА ркирк╛ркЦрлНркпрлБркВ ркЬрлЗркерлА рк╕рлНркХрлНрк░рлАрки ркнрк░рлЗрк▓рлА рк▓рк╛ркЧрлЗ */
        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: #000; /* ркмрлЗркХркЧрлНрк░рк╛ркЙркирлНркб ркХрк╛рк│рлБркВ рк░рк╛ркЦрлНркпрлБркВ */
            margin: 0;
            padding: 0;
            overflow: hidden; /* рк╕рлНркХрлНрк░рлЛрк▓ ркмркВркз */
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* рли. ркХрлЗркорлЗрк░рк╛ ркХркирлНркЯрлЗркирк░ рк╣рк╡рлЗ рк╕рлНркХрлНрк░рлАркиркирлЛ ркорлЛркЯрлЛ ркнрк╛ркЧ рк░рлЛркХрк╢рлЗ */
        .camera-container {
            position: relative;
            width: 100%;
            height: 75vh; /* рк╕рлНркХрлНрк░рлАркиркирлА рлнрлл% ркКркВркЪрк╛ркИ */
            background: #000;
            overflow: hidden;
            /* ркирлАркЪрлЗркирлА ркмрк╛ркЬрлБ ркЧрлЛрк│рк╛ркХрк╛рк░ ркЦрлВркгрк╛ */
            border-bottom-left-radius: 20px;
            border-bottom-right-radius: 20px;
        }

        #camera-stream {
            width: 100%;
            height: 100%;
            object-fit: cover; /* рк╡рк┐ркбрлАркпрлЛ ркЖркЦрлА рк╕рлНркХрлНрк░рлАркиркорк╛ркВ рклрлЗрк▓рк╛ркИ ркЬрк╢рлЗ */
        }

        /* рк╕рлНркХрлЗркирк┐ркВркЧ рк▓рк╛ркИркЯ */
        .scan-line {
            position: absolute; top: 0; left: 0;
            width: 100%; height: 5px;
            background: #00f2ff; box-shadow: 0 0 20px #00f2ff;
            opacity: 0; z-index: 10;
        }
        .scanning-animation { opacity: 1; animation: moveLight 1.5s ease-in-out; }
        @keyframes moveLight { 0% { top: 0%; } 100% { top: 100%; opacity: 0; } }

        /* рлй. ркХркВркЯрлНрк░рлЛрк▓ рккрлЗркирк▓ (ркирлАркЪрлЗркирлЛ ркнрк╛ркЧ) */
        .controls-area {
            flex: 1; /* ркмрк╛ркХрлА рк╡ркзрлЗрк▓рлА ркЬркЧрлНркпрк╛ */
            background-color: #1a1a1a;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding-bottom: 20px;
        }

        .btn-container { 
            display: flex; 
            gap: 15px; 
            margin-bottom: 10px;
        }

        .btn {
            color: white; border: none; padding: 15px 25px;
            font-size: 16px; border-radius: 50px; cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3); font-weight: bold;
        }
        #scan-btn { background-color: #007bff; width: 200px; font-size: 18px; }
        #download-pdf-btn { background-color: #28a745; display: none; }
        #download-pdf-btn.show { display: block; }

        #page-counter {
            color: #ccc; font-size: 14px; margin-bottom: 5px;
        }

        /* --- ркХрлНрк░рлЛрккрк┐ркВркЧ ркорлЛркбрк▓ --- */
        #crop-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 1000; display: none; flex-direction: column;
        }
        .crop-container { flex: 1; background: #222; position: relative; }
        #crop-image { max-width: 100%; display: block; } 
        
        .modal-buttons {
            padding: 20px; background: #000; display: flex; gap: 20px; justify-content: center;
        }
        .btn-cancel { background-color: #dc3545; }
        .btn-crop { background-color: #28a745; }

        footer {
            color: #666; font-size: 12px; margin-top: 5px;
        }
        canvas { display: none; }
    </style>
</head>
<body>

    <div class="camera-container">
        <video id="camera-stream" autoplay playsinline></video>
        <div id="scan-bar" class="scan-line"></div>
    </div>
    
    <div class="controls-area">
        <div id="page-counter">Ready to Scan</div>
        
        <div class="btn-container">
            <button id="scan-btn" class="btn">ЁЯУ╕ Scan Page</button>
        </div>
        
        <button id="download-pdf-btn" class="btn">ЁЯТ╛ Download PDF</button>

        <footer>
            App by Devendra Ramanuj | ЁЯУЮ 9276505035
        </footer>
    </div>

    <canvas id="canvas"></canvas>

    <div id="crop-modal">
        <div class="crop-container">
            <div><img id="crop-image" src=""></div>
        </div>
        <div class="modal-buttons">
            <button id="cancel-crop-btn" class="btn btn-cancel">тЭМ Cancel</button>
            <button id="finish-crop-btn" class="btn btn-crop">тЬЕ Done</button>
        </div>
    </div>

    <script>
        const video = document.getElementById('camera-stream');
        const canvas = document.getElementById('canvas');
        const scanBtn = document.getElementById('scan-btn');
        const downloadPdfBtn = document.getElementById('download-pdf-btn');
        const scanBar = document.getElementById('scan-bar');
        const pageCounter = document.getElementById('page-counter');
        
        const cropModal = document.getElementById('crop-modal');
        const cropImageEl = document.getElementById('crop-image');
        const cancelCropBtn = document.getElementById('cancel-crop-btn');
        const finishCropBtn = document.getElementById('finish-crop-btn');

        let scannedPagesList = [];
        let cropper = null;

        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: 'environment',
                        width: { ideal: 1920 },
                        height: { ideal: 1080 }
                    } 
                });
                video.srcObject = stream;
            } catch (error) {
                alert("Camera Error: " + error.message);
            }
        }

        function updateUI() {
            const count = scannedPagesList.length;
            if (count > 0) {
                pageCounter.innerText = `тЬЕ ${count} Pages Scanned`;
                downloadPdfBtn.classList.add('show');
                scanBtn.innerText = "ЁЯУ╕ Add Next";
            } else {
                pageCounter.innerText = "Ready to Scan";
                downloadPdfBtn.classList.remove('show');
                scanBtn.innerText = "ЁЯУ╕ Scan Page";
            }
        }

        scanBtn.addEventListener('click', () => {
            scanBar.classList.remove('scanning-animation');
            void scanBar.offsetWidth; 
            scanBar.classList.add('scanning-animation');
            scanBtn.disabled = true;

            setTimeout(() => {
                // ркХрлЗрккрлНркЪрк░ ркХрк░ркдрлА рк╡ркЦркдрлЗ ркУрк░рк┐ркЬрк┐ркирк▓ рк╕рк╛ркИркЭ рк╡рк╛рккрк░рлЛ
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                canvas.getContext('2d').drawImage(video, 0, 0);
                
                const rawImageData = canvas.toDataURL('image/jpeg', 0.9);
                openCropperModal(rawImageData);
                
                scanBtn.disabled = false;
                scanBar.classList.remove('scanning-animation');
            }, 1000);
        });

        function openCropperModal(imageSrc) {
            cropImageEl.src = imageSrc;
            cropModal.style.display = 'flex';
            if (cropper) cropper.destroy();
            cropper = new Cropper(cropImageEl, {
                viewMode: 1, dragMode: 'move', autoCropArea: 0.8, movable: true, zoomable: true,
            });
        }

        cancelCropBtn.addEventListener('click', () => {
            cropModal.style.display = 'none';
            if (cropper) { cropper.destroy(); cropper = null; }
        });

        finishCropBtn.addEventListener('click', () => {
            if (!cropper) return;
            const croppedCanvas = cropper.getCroppedCanvas({ maxWidth: 1600 });
            const finalImage = croppedCanvas.toDataURL('image/jpeg', 0.85);
            scannedPagesList.push(finalImage);
            cropModal.style.display = 'none';
            cropper.destroy(); cropper = null;
            updateUI();
        });

        downloadPdfBtn.addEventListener('click', () => {
            if (scannedPagesList.length === 0) return;
            downloadPdfBtn.innerText = "Processing...";
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const pageWidth = 210; 
            const margin = 10;

            scannedPagesList.forEach((imgData, index) => {
                if (index > 0) doc.addPage();
                const imgProps = doc.getImageProperties(imgData);
                const pdfImgWidth = pageWidth - (margin * 2);
                const pdfImgHeight = (imgProps.height * pdfImgWidth) / imgProps.width;
                doc.addImage(imgData, 'JPEG', margin, margin, pdfImgWidth, pdfImgHeight);
            });

            const timestamp = new Date().getTime();
            doc.save(`Scan_${timestamp}.pdf`);
            
            downloadPdfBtn.innerText = "ЁЯТ╛ Download PDF";
        });

        startCamera();
        updateUI();
    </script>

</body>
</html>
