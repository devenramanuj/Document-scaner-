<!DOCTYPE html>
<html lang="gu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>рккрлНрк░рлЛрклрлЗрк╢ркирк▓ PDF рк╕рлНркХрлЗркирк░</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link  href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

    <style>
        /* ркмрлЗркЭрк┐ркХ рк╕рлНркЯрк╛ркЗрк▓ */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f2f5;
            text-align: center;
            margin: 0;
            padding-bottom: 100px;
            overscroll-behavior-y: contain; /* рккрлБрк▓-ркЯрлБ-рк░рлАрклрлНрк░рлЗрк╢ ркЕркЯркХрк╛рк╡рк╡рк╛ */
        }
        h2 { color: #333; margin: 15px 0; }

        /* ркХрлЗркорлЗрк░рк╛ рк╡рк┐ркнрк╛ркЧ */
        .camera-container {
            position: relative;
            width: 95%; max-width: 400px;
            margin: 0 auto;
            border-radius: 12px; overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            background: #000;
        }
        #camera-stream { width: 100%; display: block; }

        /* рк╕рлНркХрлЗркирк┐ркВркЧ ркПркирк┐ркорлЗрк╢рки */
        .scan-line {
            position: absolute; top: 0; left: 0;
            width: 100%; height: 4px;
            background: #00f2ff; box-shadow: 0 0 10px #00f2ff;
            opacity: 0; z-index: 5;
        }
        .scanning-animation { opacity: 1; animation: moveLight 1.5s ease-in-out; }
        @keyframes moveLight {
            0% { top: 0%; } 100% { top: 100%; opacity: 0; }
        }

        /* ркмркЯркирлЛ */
        .btn-container { margin: 20px 0; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;}
        .btn {
            color: white; border: none; padding: 12px 24px;
            font-size: 16px; border-radius: 50px; cursor: pointer;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); font-weight: 600;
            transition: all 0.2s;
            display: flex; align-items: center; justify-content: center;
        }
        .btn:active { transform: scale(0.95); }
        #scan-btn { background-color: #007bff; }
        #download-pdf-btn { background-color: #28a745; display: none; /* рк╢рк░рлВркЖркдркорк╛ркВ ркЫрлБрккрк╛рк╡рлЛ */ }
        #download-pdf-btn.show { display: flex; }

        /* рккрлЗркЬ ркХрк╛ркЙркирлНркЯрк░ */
        #page-counter {
            font-weight: bold; color: #555; margin: 10px 0; display: none;
        }

        /* --- ркХрлНрк░рлЛрккрк┐ркВркЧ ркорлЛркбрк▓ (Popup) --- */
        #crop-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 1000;
            display: none; flex-direction: column;
        }
        .crop-container {
            flex: 1; width: 100%; background: #333; position: relative;
            max-height: 80vh; /* рк╕рлНркХрлНрк░рлАркиркирлА 80% рк╣рк╛ркИркЯ */
        }
        /* ркХрлНрк░рлЛрккрк░ркирлА ркИркорлЗркЬ ркмрк░рк╛ркмрк░ рклрк┐ркЯ ркерк╛ркп */
        #crop-image { max-width: 100%; display: block; } 
        
        .modal-buttons {
            padding: 15px; background: #222; display: flex; gap: 15px; justify-content: center;
        }
        .btn-cancel { background-color: #dc3545; }
        .btn-crop { background-color: #28a745; }

        /* рклрлВркЯрк░ */
        footer {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background-color: #2c3e50; color: #bdc3c7;
            text-align: center; padding: 12px 0; font-size: 13px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1); z-index: 90;
        }
        footer span { font-weight: bold; color: #f1c40f; }
        canvas { display: none; }
    </style>
</head>
<body>

    <h2>ЁЯУС рккрлНрк░рлЛ рк╕рлНркХрлЗркирк░ (Multi-Page & Crop)</h2>
    
    <div class="camera-container">
        <video id="camera-stream" autoplay playsinline></video>
        <div id="scan-bar" class="scan-line"></div>
    </div>
    
    <div class="btn-container">
        <button id="scan-btn" class="btn">ЁЯУ╕ Scan New Page</button>
        <button id="download-pdf-btn" class="btn">ЁЯТ╛ Download Final PDF</button>
    </div>

    <div id="page-counter">рк╣рк╛рк▓ркорк╛ркВ 0 рккрлЗркЬ рк╕рлНркХрлЗрки ркХрк░рлЗрк▓рк╛ ркЫрлЗ.</div>

    <canvas id="canvas"></canvas>

    <div id="crop-modal">
        <div class="crop-container">
            <div><img id="crop-image" src=""></div>
        </div>
        <div class="modal-buttons">
            <button id="cancel-crop-btn" class="btn btn-cancel">тЭМ Cancel</button>
            <button id="finish-crop-btn" class="btn btn-crop">тЬЕ Crop & Add Page</button>
        </div>
    </div>

    <footer>
        Developed by <span>Devendra Ramanuj</span> | ЁЯУЮ 9276505035
    </footer>

    <script>
        // ркПрк▓рк┐ркорлЗркирлНркЯрлНрк╕ ркорлЗрк│рк╡рлЛ
        const video = document.getElementById('camera-stream');
        const canvas = document.getElementById('canvas');
        const scanBtn = document.getElementById('scan-btn');
        const downloadPdfBtn = document.getElementById('download-pdf-btn');
        const scanBar = document.getElementById('scan-bar');
        const pageCounter = document.getElementById('page-counter');
        
        // ркорлЛркбрк▓ ркПрк▓рк┐ркорлЗркирлНркЯрлНрк╕
        const cropModal = document.getElementById('crop-modal');
        const cropImageEl = document.getElementById('crop-image');
        const cancelCropBtn = document.getElementById('cancel-crop-btn');
        const finishCropBtn = document.getElementById('finish-crop-btn');

        // рк╕рлНркЯрлЗркЯ рк╡рлЗрк░рлАркПркмрк▓рлНрк╕
        let scannedPagesList = []; // рк╕рлНркХрлЗрки ркеркпрлЗрк▓рк╛ ркмркзрк╛ рккрлЗркЬ ркЕрк╣рлАркВ рк╕рлНркЯрлЛрк░ ркерк╢рлЗ
        let cropper = null; // ркХрлНрк░рлЛрккрк░ркирлЛ ркЗркирлНрк╕рлНркЯркирлНрк╕

        // рлз. ркХрлЗркорлЗрк░рк╛ рк╢рк░рлВ ркХрк░рлЛ
        async function startCamera() {
            try {
                // рккрк╛ркЫрк│ркирлЛ ркХрлЗркорлЗрк░рлЛ, ркЕркирлЗ рк╣рк╛ркИ рк░рлЗркЭрлЛрк▓рлНркпрлБрк╢рки ркорк╛ркЯрлЗ рккрлНрк░ркпркдрлНрки ркХрк░рлЛ
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: 'environment',
                        width: { ideal: 1920 },
                        height: { ideal: 1080 }
                    } 
                });
                video.srcObject = stream;
            } catch (error) {
                alert("ркХрлЗркорлЗрк░рк╛ ркПркХрлНрк╕рлЗрк╕ ркХрк░рк╡рк╛ркорк╛ркВ ркнрлВрк▓: " + error.message + "\nркХрлГрккрк╛ ркХрк░рлАркирлЗ HTTPS ркЕркерк╡рк╛ localhost ркирлЛ ркЙрккркпрлЛркЧ ркХрк░рлЛ.");
            }
        }

        // UI ркЕрккркбрлЗркЯ ркХрк░рк╡рк╛ркирлБркВ рклркВркХрлНрк╢рки
        function updateUI() {
            const count = scannedPagesList.length;
            if (count > 0) {
                pageCounter.style.display = 'block';
                pageCounter.innerText = `тЬЕ рк╣рк╛рк▓ркорк╛ркВ ${count} рккрлЗркЬ ркдрлИркпрк╛рк░ ркЫрлЗ.`;
                downloadPdfBtn.classList.add('show'); // PDF ркмркЯрки ркмркдрк╛рк╡рлЛ
                scanBtn.innerText = "ЁЯУ╕ Scan Next Page";
            } else {
                pageCounter.style.display = 'none';
                downloadPdfBtn.classList.remove('show'); // PDF ркмркЯрки ркЫрлБрккрк╛рк╡рлЛ
                 scanBtn.innerText = "ЁЯУ╕ Scan Page";
            }
        }

        // рли. "Scan Page" ркмркЯрки ркХрлНрк▓рк┐ркХ
        scanBtn.addEventListener('click', () => {
            // ркПркирк┐ркорлЗрк╢рки ркЪрк▓рк╛рк╡рлЛ
            scanBar.classList.remove('scanning-animation');
            void scanBar.offsetWidth; 
            scanBar.classList.add('scanning-animation');
            scanBtn.disabled = true;

            // рлз.рли рк╕рлЗркХркирлНркб рккркЫрлА рклрлЛркЯрлЛ ркХрлЗрккрлНркЪрк░ ркХрк░рлЛ
            setTimeout(() => {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                canvas.getContext('2d').drawImage(video, 0, 0);
                
                // рклрлЛркЯрк╛ркирлЗ ркбрлЗркЯрк╛ URL ркорк╛ркВ рклрлЗрк░рк╡рлЛ
                const rawImageData = canvas.toDataURL('image/jpeg', 0.9);
                
                // ркХрлНрк░рлЛрккрк┐ркВркЧ ркорлЛркбрк▓ ркЦрлЛрк▓рлЛ
                openCropperModal(rawImageData);
                
                scanBtn.disabled = false;
                scanBar.classList.remove('scanning-animation');
            }, 1200);
        });

        // рлй. ркХрлНрк░рлЛрккрк░ ркорлЛркбрк▓ ркЦрлЛрк▓рк╡рлБркВ ркЕркирлЗ рк╕рлЗркЯркЕркк ркХрк░рк╡рлБркВ
        function openCropperModal(imageSrc) {
            cropImageEl.src = imageSrc;
            cropModal.style.display = 'flex'; // ркорлЛркбрк▓ ркмркдрк╛рк╡рлЛ

            // ркЬрлЛ ркЬрлВркирлБркВ ркХрлНрк░рлЛрккрк░ рк╣рлЛркп ркдрлЛ ркбрк┐рк▓рлАркЯ ркХрк░рлЛ
            if (cropper) { cropper.destroy(); }

            // ркирк╡рлБркВ Cropper.js рк╢рк░рлВ ркХрк░рлЛ
            cropper = new Cropper(cropImageEl, {
                viewMode: 1, // ркЗркорлЗркЬ ркХркирлНркЯрлЗркирк░ркирлА ркЕркВркжрк░ ркЬ рк░рк╣рлЗ
                dragMode: 'move', // рклрлЛркЯрлЛ рк╣рк▓рк╛рк╡рлА рк╢ркХрк╛ркп
                autoCropArea: 0.8, // рк╢рк░рлВркЖркдркорк╛ркВ 80% рк╕рк┐рк▓рлЗркХрлНркЯ ркХрк░рлЛ
                movable: true,
                zoomable: true,
                scalable: false,
                rotatable: false,
            });
        }

        // рлк. "Cancel Crop" ркмркЯрки
        cancelCropBtn.addEventListener('click', () => {
            cropModal.style.display = 'none'; // ркорлЛркбрк▓ ркмркВркз ркХрк░рлЛ
            if (cropper) { cropper.destroy(); cropper = null; }
        });

        // рлл. "Crop & Add Page" ркмркЯрки - (ркорк╣ркдрлНрк╡ркирлБркВ)
        finishCropBtn.addEventListener('click', () => {
            if (!cropper) return;

            // ркХрлНрк░рлЛркк ркХрк░рлЗрк▓рлЛ ркнрк╛ркЧ ркорлЗрк│рк╡рлЛ (Canvas ркдрк░рлАркХрлЗ)
            const croppedCanvas = cropper.getCroppedCanvas({
                maxWidth: 1600, // ркмрк╣рлБ ркорлЛркЯрлА рк╕рк╛ркИркЭ рки ркеркИ ркЬрк╛ркп ркдрлЗ ркорк╛ркЯрлЗ
                imageSmoothingQuality: 'high',
            });

            // ркдрлЗркирлЗ JPG ркЗркорлЗркЬ ркбрлЗркЯрк╛ркорк╛ркВ рклрлЗрк░рк╡рлЛ
            const finalImage = croppedCanvas.toDataURL('image/jpeg', 0.85);

            // ркЖрккркгрк╛ рк▓рк┐рк╕рлНркЯркорк╛ркВ ркЙркорлЗрк░рлЛ
            scannedPagesList.push(finalImage);

            // ркорлЛркбрк▓ ркмркВркз ркХрк░рлЛ ркЕркирлЗ UI ркЕрккркбрлЗркЯ ркХрк░рлЛ
            cropModal.style.display = 'none';
            cropper.destroy(); cropper = null;
            updateUI();

            // ркерлЛркбрлБркВ рк╡рк╛ркИркмрлНрк░рлЗрк╢рки ркЖрккрлЛ (ркЬрлЛ рклрлЛрки рк╕рккрлЛрк░рлНркЯ ркХрк░рлЗ ркдрлЛ)
            if (navigator.vibrate) navigator.vibrate(50);
        });

        // рлм. рклрк╛ркИркирк▓ "Download PDF" ркмркЯрки
        downloadPdfBtn.addEventListener('click', () => {
            if (scannedPagesList.length === 0) return;
            
            downloadPdfBtn.innerText = "Generating PDF...";
            downloadPdfBtn.disabled = true;

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF(); // A4 рк╕рк╛ркИркЭ ркбрк┐рклрлЛрк▓рлНркЯ

            const pageWidth = 210; // A4 width mm
            const pageHeight = 297; // A4 height mm
            const margin = 10;

            // рк▓рк┐рк╕рлНркЯркорк╛ркВ рк░рк╣рлЗрк▓рк╛ ркжрк░рлЗркХ рклрлЛркЯрк╛ ркорк╛ркЯрлЗ рк▓рлВркк ркЪрк▓рк╛рк╡рлЛ
            scannedPagesList.forEach((imgData, index) => {
                // ркЬрлЛ рккрк╣рлЗрк▓рлБркВ рккрлЗркЬ рки рк╣рлЛркп, ркдрлЛ ркирк╡рлБркВ рккрлЗркЬ ркЙркорлЗрк░рлЛ
                if (index > 0) {
                    doc.addPage();
                }

                // ркЗркорлЗркЬ рккрлНрк░рлЛрккрк░рлНркЯрлАркЭ ркорлЗрк│рк╡рлЛ (aspect ratio ркЬрк╛ркгрк╡рк╛ ркорк╛ркЯрлЗ)
                const imgProps = doc.getImageProperties(imgData);
                const pdfImgWidth = pageWidth - (margin * 2);
                const pdfImgHeight = (imgProps.height * pdfImgWidth) / imgProps.width;

                // ркЗркорлЗркЬркирлЗ PDF ркорк╛ркВ ркЙркорлЗрк░рлЛ (x, y, width, height)
                doc.addImage(imgData, 'JPEG', margin, margin, pdfImgWidth, pdfImgHeight);
                
                doc.setFontSize(10);
                doc.text(`Page ${index + 1}`, pageWidth / 2, pageHeight - 5, { align: 'center' });
            });

            // PDF рк╕рлЗрк╡ ркХрк░рлЛ
            const timestamp = new Date().getTime();
            doc.save(`Document_Scan_${timestamp}.pdf`);

            // рк░рлАрк╕рлЗркЯ ркХрк░рлЛ
            downloadPdfBtn.innerText = "ЁЯТ╛ Download Final PDF";
            downloadPdfBtn.disabled = false;
        });

        // ркПрккрлНрк▓рк┐ркХрлЗрк╢рки рк╢рк░рлВ ркХрк░рлЛ
        startCamera();
        updateUI();
    </script>

</body>
</html>
